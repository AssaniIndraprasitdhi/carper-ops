@model Capet_OPS.Models.Entities.LayoutPlan
@{
    ViewData["Title"] = $"Plan {Model.PlanCode}";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <a href="/Layout/Plans" class="text-decoration-none text-muted" style="font-size:0.78rem;">
            <i class="bi bi-arrow-left me-1"></i>กลับไปรายการแผน
        </a>
        <h5 class="fw-bold mt-1 mb-0">
            <i class="bi bi-file-earmark-text me-1"></i>@Model.PlanCode
        </h5>
    </div>
    <div class="d-flex align-items-center gap-2">
        <a href="/Layout/Index?editPlanId=@Model.Id" class="btn btn-warning btn-sm">
            <i class="bi bi-pencil me-1"></i>แก้ไข
        </a>
        <button id="btnExportCsv" class="btn btn-success btn-sm" onclick="exportPlanCsv()">
            <i class="bi bi-file-earmark-excel me-1"></i>Export
        </button>
        <a href="/Layout/Report/@Model.Id" target="_blank" class="btn btn-primary btn-sm">
            <i class="bi bi-printer me-1"></i>พิมพ์
        </a>
        <span class="badge fs-6 @(Model.Status == "planned" ? "bg-primary" : Model.Status == "completed" ? "bg-success" : "bg-secondary")">
            @Model.Status.ToUpper()
        </span>
    </div>
</div>

<!-- Plan Info + Metrics in single row -->
<div class="row g-3 mb-3">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-body py-2 px-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <div class="text-muted" style="font-size:0.68rem;">ชนิดผ้าใบ</div>
                        <div class="fw-medium small">@Model.CanvasType?.CnvDesc</div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted" style="font-size:0.68rem;">ความกว้าง</div>
                        <div class="fw-medium small">@Model.RollWidth ม.</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted" style="font-size:0.68rem;">วันที่สร้าง</div>
                        <div class="fw-medium small">@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm")</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted" style="font-size:0.68rem;">สถานะ</div>
                        <div class="fw-medium small">@Model.Status</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-body py-2 px-3">
                <div class="row text-center g-1">
                    <div class="col-4">
                        <div class="text-muted" style="font-size:0.65rem;">ประสิทธิภาพ</div>
                        <div class="fs-5 fw-bold" style="color: var(--green);">@Model.EfficiencyPct%</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted" style="font-size:0.65rem;">จำนวนชิ้น</div>
                        <div class="fs-5 fw-bold" style="color: var(--orange);">@Model.PieceCount</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted" style="font-size:0.65rem;">ยาวรวม</div>
                        <div class="fs-5 fw-bold" style="color: var(--accent);">@Model.TotalLength ม.</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted" style="font-size:0.65rem;">ใช้จริง</div>
                        <div class="fw-bold small" style="color: var(--accent);">@Model.UsedArea ตร.ม.</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted" style="font-size:0.65rem;">สูญเสีย</div>
                        <div class="fw-bold small" style="color: var(--red);">@Model.WasteArea ตร.ม.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Layout Visualization -->
<div class="card mb-3">
    <div class="card-body p-2" id="canvasContainer" style="overflow: auto; max-height: 45vh;">
        <canvas id="layoutCanvas"></canvas>
    </div>
</div>

<!-- Items Table -->
<div class="card">
    <div class="card-header bg-white py-2 px-3 d-flex justify-content-between align-items-center">
        <span class="fw-medium small"><i class="bi bi-table me-1"></i>รายการในแผน</span>
        <span class="badge bg-light text-dark" style="font-size:0.65rem;">@Model.Items.Count รายการ</span>
    </div>
    @{
        int idx = 1;
        bool hasTag = Model.Items.Any(i => i.TagWidth.HasValue || i.TagLength.HasValue);
    }
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 35vh; overflow-y: auto;">
            <table class="table table-hover table-sm mb-0" style="font-size:0.75rem;">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>Barcode</th>
                        <th>Order</th>
                        <th class="text-end">พรม W</th>
                        <th class="text-end">พรม L</th>
                        <th class="text-end">พท.พรม</th>
                        @if (hasTag)
                        {
                            <th class="text-end">Tag W</th>
                            <th class="text-end">Tag L</th>
                            <th class="text-end">พท.Tag</th>
                            <th class="text-end">%เผื่อ Tag</th>
                        }
                        <th class="text-end">ตัด W</th>
                        <th class="text-end">ตัด L</th>
                        <th class="text-end">พท.ตัด</th>
                        @if (hasTag)
                        {
                            <th class="text-end">%เผื่อ ตัด</th>
                        }
                        <th class="text-end">%สูญเสีย</th>
                        <th>Type</th>
                        <th>R</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items)
                    {
                        var carpetArea = item.Width * item.Length;
                        var cutArea = item.PackWidth * item.PackLength;
                        var tagArea = (item.TagWidth.HasValue && item.TagLength.HasValue)
                            ? item.TagWidth.Value * item.TagLength.Value : (decimal?)null;
                        var tagAllowPct = (tagArea.HasValue && carpetArea > 0)
                            ? ((tagArea.Value - carpetArea) / carpetArea * 100) : (decimal?)null;
                        var cutVsTagPct = (tagArea.HasValue && tagArea.Value > 0)
                            ? ((cutArea - tagArea.Value) / tagArea.Value * 100) : (decimal?)null;
                        var wastePct = carpetArea > 0 ? ((cutArea - carpetArea) / carpetArea * 100) : (decimal?)null;
                        <tr>
                            <td>@idx</td>
                            <td><code class="small">@item.BarcodeNo</code></td>
                            <td class="small">@item.Orno</td>
                            <td class="text-end small">@item.Width.ToString("N2")</td>
                            <td class="text-end small">@item.Length.ToString("N2")</td>
                            <td class="text-end small">@carpetArea.ToString("N2")</td>
                            @if (hasTag)
                            {
                                <td class="text-end small">@(item.TagWidth.HasValue ? item.TagWidth.Value.ToString("N2") : "-")</td>
                                <td class="text-end small">@(item.TagLength.HasValue ? item.TagLength.Value.ToString("N2") : "-")</td>
                                <td class="text-end small">@(tagArea.HasValue ? tagArea.Value.ToString("N2") : "-")</td>
                                <td class="text-end small fw-medium" style="color:@(tagAllowPct.HasValue ? (tagAllowPct.Value <= 5 ? "var(--green)" : tagAllowPct.Value <= 15 ? "var(--orange)" : "var(--red)") : "inherit");">
                                    @(tagAllowPct.HasValue ? tagAllowPct.Value.ToString("N1") + "%" : "-")
                                </td>
                            }
                            <td class="text-end small">@item.PackWidth.ToString("N2")</td>
                            <td class="text-end small">@item.PackLength.ToString("N2")</td>
                            <td class="text-end small">@cutArea.ToString("N2")</td>
                            @if (hasTag)
                            {
                                <td class="text-end small fw-medium" style="color:@(cutVsTagPct.HasValue ? (cutVsTagPct.Value <= 5 ? "var(--green)" : cutVsTagPct.Value <= 15 ? "var(--orange)" : "var(--red)") : "inherit");">
                                    @(cutVsTagPct.HasValue ? cutVsTagPct.Value.ToString("N1") + "%" : "-")
                                </td>
                            }
                            <td class="text-end small fw-medium" style="color:@(wastePct.HasValue ? (wastePct.Value <= 10 ? "var(--green)" : wastePct.Value <= 20 ? "var(--orange)" : "var(--red)") : "inherit");">
                                @(wastePct.HasValue ? wastePct.Value.ToString("N1") + "%" : "-")
                            </td>
                            <td>
                                <span class="badge @(item.OrderType == "Order" ? "bg-primary" : "bg-info")" style="font-size:0.65rem;">@item.OrderType</span>
                            </td>
                            <td class="small">@(item.IsRotated ? "Yes" : "-")</td>
                        </tr>
                        idx++;
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/canvas-renderer.js" asp-append-version="true"></script>
    <script>
        function exportPlanCsv() {
            const header = ['#', 'Barcode', 'Order', 'พรม W(m)', 'พรม L(m)', 'พท.พรม(sqm)',
                @(hasTag ? "'Tag W(m)','Tag L(m)','พท.Tag(sqm)','%เผื่อ Tag'," : "")
                'ตัด W(m)', 'ตัด L(m)', 'พท.ตัด(sqm)',
                @(hasTag ? "'%เผื่อ ตัด'," : "")
                '%สูญเสีย', 'Type', 'Rotated'];
            const rows = [header];
            @{ int csvIdx = 1; }
            @foreach (var item in Model.Items)
            {
                var cA = item.Width * item.Length;
                var cuA = item.PackWidth * item.PackLength;
                var tA = (item.TagWidth.HasValue && item.TagLength.HasValue) ? item.TagWidth.Value * item.TagLength.Value : (decimal?)null;
                var tPct = (tA.HasValue && cA > 0) ? ((tA.Value - cA) / cA * 100) : (decimal?)null;
                var cvtPct = (tA.HasValue && tA.Value > 0) ? ((cuA - tA.Value) / tA.Value * 100) : (decimal?)null;
                var wPct = cA > 0 ? ((cuA - cA) / cA * 100) : (decimal?)null;
                <text>rows.push([@csvIdx,'@item.BarcodeNo','@item.Orno',@item.Width.ToString("N2"),@item.Length.ToString("N2"),@cA.ToString("N2"),
                    @(hasTag ? $"{(item.TagWidth.HasValue ? item.TagWidth.Value.ToString("N2") : "'-'")},{(item.TagLength.HasValue ? item.TagLength.Value.ToString("N2") : "'-'")},{(tA.HasValue ? tA.Value.ToString("N2") : "'-'")},{(tPct.HasValue ? tPct.Value.ToString("N1") : "'-'")}," : "")
                    @item.PackWidth.ToString("N2"),@item.PackLength.ToString("N2"),@cuA.ToString("N2"),
                    @(hasTag ? $"{(cvtPct.HasValue ? cvtPct.Value.ToString("N1") : "'-'")}," : "")
                    @(wPct.HasValue ? wPct.Value.ToString("N1") : "'-'"),'@item.OrderType','@(item.IsRotated ? "Yes" : "-")']);</text>
                csvIdx++;
            }
            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '@(Model.PlanCode)-detail.csv';
            link.click();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const planData = @Html.Raw(Model.LayoutJson ?? "[]");
            const rollWidth = @Model.RollWidth;
            const totalLength = @Model.TotalLength;

            if (planData && planData.length > 0) {
                const result = {
                    rollWidth: rollWidth,
                    totalLength: totalLength,
                    packedItems: planData.map(item => ({
                        packX: item.PackX ?? item.packX,
                        packY: item.PackY ?? item.packY,
                        packWidth: item.PackWidth ?? item.packWidth,
                        packLength: item.PackLength ?? item.packLength,
                        orno: item.ORNO ?? item.orno ?? item.oRNO,
                        originalWidth: item.OriginalWidth ?? item.originalWidth,
                        originalLength: item.OriginalLength ?? item.originalLength,
                        isRotated: item.IsRotated ?? item.isRotated
                    }))
                };
                const renderer = new CanvasRenderer('layoutCanvas');
                renderer.render(result);
            }
        });
    </script>
}
