@model Capet_OPS.Models.Entities.LayoutPlan
@{
    ViewData["Title"] = $"Plan {Model.PlanCode}";
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <a href="/Layout/Plans" class="text-decoration-none text-muted" style="font-size:0.78rem;">
            <i class="bi bi-arrow-left me-1"></i>กลับไปรายการแผน
        </a>
        <h5 class="fw-bold mt-1 mb-0">
            <i class="bi bi-file-earmark-text me-1"></i>@Model.PlanCode
        </h5>
    </div>
    <div class="d-flex align-items-center gap-2">
        <a href="/Layout/Index?editPlanId=@Model.Id" class="btn btn-warning btn-sm">
            <i class="bi bi-pencil me-1"></i>แก้ไข
        </a>
        <span class="badge fs-6 @(Model.Status == "planned" ? "bg-primary" : Model.Status == "completed" ? "bg-success" : "bg-secondary")">
            @Model.Status.ToUpper()
        </span>
    </div>
</div>

<!-- Plan Info + Metrics in single row -->
<div class="row g-3 mb-3">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-body py-2 px-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <div class="text-muted" style="font-size:0.68rem;">ชนิดผ้าใบ</div>
                        <div class="fw-medium small">@Model.CanvasType?.CnvDesc</div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-muted" style="font-size:0.68rem;">ความกว้าง</div>
                        <div class="fw-medium small">@Model.RollWidth ม.</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted" style="font-size:0.68rem;">วันที่สร้าง</div>
                        <div class="fw-medium small">@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm")</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted" style="font-size:0.68rem;">สถานะ</div>
                        <div class="fw-medium small">@Model.Status</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-body py-2 px-3">
                <div class="row text-center g-1">
                    <div class="col-4">
                        <div class="text-muted" style="font-size:0.65rem;">ประสิทธิภาพ</div>
                        <div class="fs-5 fw-bold" style="color: var(--green);">@Model.EfficiencyPct%</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted" style="font-size:0.65rem;">จำนวนชิ้น</div>
                        <div class="fs-5 fw-bold" style="color: var(--orange);">@Model.PieceCount</div>
                    </div>
                    <div class="col-4">
                        <div class="text-muted" style="font-size:0.65rem;">ยาวรวม</div>
                        <div class="fs-5 fw-bold" style="color: var(--accent);">@Model.TotalLength ม.</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted" style="font-size:0.65rem;">ใช้จริง</div>
                        <div class="fw-bold small" style="color: var(--accent);">@Model.UsedArea ตร.ม.</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted" style="font-size:0.65rem;">สูญเสีย</div>
                        <div class="fw-bold small" style="color: var(--red);">@Model.WasteArea ตร.ม.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Layout Visualization -->
<div class="card mb-3">
    <div class="card-body p-2" id="canvasContainer" style="overflow: auto; max-height: 45vh;">
        <canvas id="layoutCanvas"></canvas>
    </div>
</div>

<!-- Items Table -->
<div class="card">
    <div class="card-header bg-white py-2 px-3 d-flex justify-content-between align-items-center">
        <span class="fw-medium small"><i class="bi bi-table me-1"></i>รายการในแผน</span>
        <span class="badge bg-light text-dark" style="font-size:0.65rem;">@Model.Items.Count รายการ</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 35vh; overflow-y: auto;">
            <table class="table table-hover table-sm mb-0">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th>#</th>
                        <th>Barcode</th>
                        <th>Order</th>
                        <th>Item No</th>
                        <th>W (m)</th>
                        <th>L (m)</th>
                        <th>Area</th>
                        <th>Qty</th>
                        <th>Type</th>
                        <th>Position</th>
                        <th>Rotated</th>
                    </tr>
                </thead>
                <tbody>
                    @{ int idx = 1; }
                    @foreach (var item in Model.Items)
                    {
                        <tr>
                            <td>@idx</td>
                            <td><code class="small">@item.BarcodeNo</code></td>
                            <td class="small">@item.Orno</td>
                            <td class="small">@item.ItemNo</td>
                            <td class="small">@item.Width</td>
                            <td class="small">@item.Length</td>
                            <td class="small">@item.Area</td>
                            <td class="small">@item.Qty</td>
                            <td>
                                <span class="badge @(item.OrderType == "Order" ? "bg-primary" : "bg-info")" style="font-size:0.65rem;">@item.OrderType</span>
                            </td>
                            <td class="small">(@item.PackX, @item.PackY)</td>
                            <td class="small">@(item.IsRotated ? "Yes" : "-")</td>
                        </tr>
                        idx++;
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/canvas-renderer.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const planData = @Html.Raw(Model.LayoutJson ?? "[]");
            const rollWidth = @Model.RollWidth;
            const totalLength = @Model.TotalLength;

            if (planData && planData.length > 0) {
                const result = {
                    rollWidth: rollWidth,
                    totalLength: totalLength,
                    packedItems: planData.map(item => ({
                        packX: item.PackX ?? item.packX,
                        packY: item.PackY ?? item.packY,
                        packWidth: item.PackWidth ?? item.packWidth,
                        packLength: item.PackLength ?? item.packLength,
                        orno: item.ORNO ?? item.orno ?? item.oRNO,
                        originalWidth: item.OriginalWidth ?? item.originalWidth,
                        originalLength: item.OriginalLength ?? item.originalLength,
                        isRotated: item.IsRotated ?? item.isRotated
                    }))
                };
                const renderer = new CanvasRenderer('layoutCanvas');
                renderer.render(result);
            }
        });
    </script>
}
